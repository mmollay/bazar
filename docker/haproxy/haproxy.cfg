# HAProxy Configuration for Bazar Marketplace Load Balancing

global
    daemon
    user haproxy
    group haproxy
    pidfile /var/run/haproxy.pid
    maxconn 4096
    nbthread 4
    
    # Logging
    log stdout local0 info
    
    # SSL/TLS configuration
    ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
    ssl-default-bind-options prefer-client-ciphers no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-server-ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
    ssl-default-server-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets
    
    # Performance tuning
    tune.ssl.default-dh-param 2048
    tune.bufsize 32768
    tune.maxrewrite 1024
    tune.http.maxhdr 101

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 10s
    timeout http-keep-alive 2s
    timeout check 10s
    
    # Compression
    compression algo gzip
    compression type text/html text/plain text/css text/javascript application/javascript application/json application/xml text/xml
    
    # Logging
    option httplog
    option dontlognull
    option log-health-checks
    
    # Error handling
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http
    
    # Health checks
    default-server init-addr last,libc,none

# Statistics page
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth admin:${HAPROXY_STATS_PASSWORD:-admin123}
    stats show-legends
    stats show-node
    stats hide-version

# Frontend for HTTP traffic (redirects to HTTPS)
frontend http_frontend
    bind *:80
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request reject if { sc_http_req_rate(0) gt 20 }
    
    # Security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    
    # Health check endpoint
    acl is_health path_beg /health
    use_backend health_backend if is_health
    
    # Let's Encrypt challenge
    acl is_letsencrypt path_beg /.well-known/acme-challenge/
    use_backend letsencrypt_backend if is_letsencrypt
    
    # Redirect HTTP to HTTPS
    redirect scheme https code 301 if !{ ssl_fc }

# Frontend for HTTPS traffic
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/bazar.pem alpn h2,http/1.1
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s),gpc0
    http-request track-sc0 src
    http-request reject if { sc_http_req_rate(0) gt 100 }
    
    # DDoS protection
    http-request deny if { sc_get_gpc0(0) gt 0 }
    http-request sc-inc-gpc0(0) if { status 429 }
    
    # Security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self';"
    
    # Health check endpoint
    acl is_health path_beg /health
    use_backend health_backend if is_health
    
    # API endpoints
    acl is_api path_beg /backend/api/
    use_backend api_backend if is_api
    
    # Admin panel
    acl is_admin path_beg /admin/
    use_backend admin_backend if is_admin
    
    # Static files
    acl is_static path_beg /frontend/assets/
    acl is_uploads path_beg /uploads/
    use_backend static_backend if is_static or is_uploads
    
    # WebSocket connections
    acl is_websocket hdr(upgrade) -i websocket
    use_backend websocket_backend if is_websocket
    
    # Default backend
    default_backend web_backend

# Backend for web servers
backend web_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Cookie-based session persistence
    cookie SERVERID insert indirect nocache
    
    # Compression
    compression algo gzip
    compression type text/html text/plain text/css text/javascript application/javascript application/json
    
    # Dynamic server configuration (Docker Swarm integration)
    server-template web 10 bazar_app:80 check cookie web resolvers docker init-addr none
    
    # Static server configuration for non-swarm deployments
    # server web1 app:80 check cookie web1 maxconn 32
    # server web2 app:80 check cookie web2 maxconn 32
    # server web3 app:80 check cookie web3 maxconn 32

# Backend for API endpoints
backend api_backend
    balance leastconn
    option httpchk GET /backend/api/health
    http-check expect status 200
    
    # Rate limiting for API
    stick-table type ip size 50k expire 10m store http_req_rate(10s)
    http-request track-sc1 src
    http-request reject if { sc_http_req_rate(1) gt 60 }
    
    server-template api 10 bazar_app:80 check resolvers docker init-addr none

# Backend for admin panel
backend admin_backend
    balance roundrobin
    option httpchk GET /admin/health
    http-check expect status 200
    
    # IP whitelist for admin (configure as needed)
    # acl admin_allowed src 192.168.1.0/24 10.0.0.0/8
    # http-request deny unless admin_allowed
    
    server-template admin 3 bazar_app:80 check resolvers docker init-addr none

# Backend for static files
backend static_backend
    balance roundrobin
    option httpchk GET /health
    
    # Long cache headers for static content
    http-response set-header Cache-Control "public, max-age=31536000, immutable"
    
    server-template static 5 bazar_app:80 check resolvers docker init-addr none

# Backend for WebSocket connections
backend websocket_backend
    balance source
    option httpchk GET /health
    
    # WebSocket specific settings
    timeout server 3600s
    timeout tunnel 3600s
    
    server-template ws 5 bazar_app:80 check resolvers docker init-addr none

# Health check backend
backend health_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server-template health 3 bazar_app:80 check resolvers docker init-addr none

# Let's Encrypt backend
backend letsencrypt_backend
    balance roundrobin
    server letsencrypt 127.0.0.1:8888 check

# MySQL load balancing (read/write split)
backend mysql_write
    balance roundrobin
    option mysql-check user haproxy
    server mysql-master mysql-master:3306 check

backend mysql_read
    balance roundrobin
    option mysql-check user haproxy
    server mysql-master mysql-master:3306 check weight 50
    server mysql-slave mysql-slave:3306 check weight 100

# Redis cluster backend
backend redis_backend
    balance roundrobin
    option tcp-check
    tcp-check send "PING\r\n"
    tcp-check expect string "+PONG"
    server-template redis 3 redis-cluster:6379 check resolvers docker init-addr none

# Resolvers for Docker service discovery
resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold other 10s
    hold refused 10s
    hold nx 10s
    hold timeout 10s
    hold valid 10s
    hold obsolete 10s